<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog | Aswin on Finance</title>
    <meta name="description" content="Insights and articles on finance, investing, and wealth building by Aswin.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <main class="container">
        <header class="header">
            <h1 class="page-title">Blog</h1>
        </header>

        <section class="blog-list" id="blogList">
            <!-- Blog posts will be rendered here -->
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <span class="footer-icon">‚ú¶</span>
                <span class="footer-name">Aswin on Finance</span>
            </div>
            <div class="footer-tagline">
                <span>insights for the curious</span>
            </div>
        </div>
    </footer>

    <script type="module">
        import { supabase } from '../js/supabase-client.js';

        const CACHE_KEY = 'blogPosts';
        const CACHE_TIME_KEY = 'blogPostsTime';
        const CACHE_MAX_AGE = 5 * 60 * 1000; // 5 minutes

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function renderPosts(posts) {
            const blogList = document.getElementById('blogList');

            if (!posts || posts.length === 0) {
                blogList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p class="empty-state-text">No posts yet. Check back soon!</p>
                    </div>
                `;
                return;
            }

            blogList.innerHTML = posts.map(post => {
                const date = formatDate(post.published_at);
                const postUrl = post.slug ? `post.html?slug=${post.slug}` : `post.html?id=${post.id}`;

                return `
                    <a href="${postUrl}" class="blog-item" data-id="${post.id}">
                        <div class="blog-thumbnail-wrapper">
                            <img 
                                src="${post.thumbnail_url || 'images/placeholder.webp'}" 
                                alt="${post.title}" 
                                class="blog-thumbnail"
                                loading="lazy"
                                onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e8e8e8%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2240%22>üìÑ</text></svg>'"
                            >
                        </div>
                        <div class="blog-content">
                            <h2 class="blog-title">${post.title}</h2>
                            <div class="blog-meta">
                                <span class="blog-category">${post.category || 'General'}</span>
                                <span class="blog-date">${date}</span>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
        }

        async function fetchPosts() {
            const blogList = document.getElementById('blogList');

            // Check cache first for INSTANT load
            const cachedPosts = sessionStorage.getItem(CACHE_KEY);
            const cacheTime = parseInt(sessionStorage.getItem(CACHE_TIME_KEY) || '0');
            const isCacheValid = cachedPosts && (Date.now() - cacheTime < CACHE_MAX_AGE);

            if (isCacheValid) {
                // INSTANT render from cache
                renderPosts(JSON.parse(cachedPosts));
                return;
            }

            // Show minimal loading state (only if no cache)
            blogList.innerHTML = '<div class="loading">Loading posts...</div>';

            try {
                const { data: posts, error } = await supabase
                    .from('posts')
                    .select('id, title, slug, excerpt, category, published_at, thumbnail_url')
                    .order('published_at', { ascending: false });

                if (error) throw error;

                // Cache for next time
                sessionStorage.setItem(CACHE_KEY, JSON.stringify(posts));
                sessionStorage.setItem(CACHE_TIME_KEY, Date.now().toString());

                renderPosts(posts);

            } catch (err) {
                console.error('Error fetching posts:', err);
                blogList.innerHTML = '<div class="error">Failed to load posts. Please try again later.</div>';
            }
        }

        fetchPosts();
    </script>
</body>

</html>